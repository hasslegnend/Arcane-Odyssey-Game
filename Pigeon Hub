local Players = game:GetService("Players")
local plr = Players.LocalPlayer
while not plr do
    Players.PlayerAdded:Wait()
    plr = Players.LocalPlayer
end


local PlayerGui = plr:WaitForChild("PlayerGui")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local padding = 5
local buttonWidth = 200
local buttonHeight = 30

local PigeonGui = Instance.new("ScreenGui")
PigeonGui.Parent = PlayerGui
PigeonGui.Name = "PigeonGui"

local PigeonFrame = Instance.new("Frame")
PigeonFrame.Parent = PigeonGui
PigeonFrame.Visible = true
PigeonFrame.Active = true
PigeonFrame.Position = UDim2.new(0.5,0,0.5,0)
PigeonFrame.AnchorPoint = Vector2.new(0.5, 0.5)
PigeonFrame.Size = UDim2.new(0, 475, 0, 650)
PigeonFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
PigeonFrame.BorderColor3 = Color3.fromRGB(0, 0, 139)
PigeonFrame.Selectable = true
PigeonFrame.Draggable = true

local function createTab(text, position)
	local tab = Instance.new("TextButton")
	tab.Parent = PigeonFrame
	tab.Size = UDim2.new(0, 140, 0, 35)
	tab.Position = position
	tab.Text = text
	tab.Font = Enum.Font.GothamBold
	tab.TextSize = 14
	tab.TextColor3 = Color3.fromRGB(255,255,255)
	tab.BackgroundColor3 = Color3.fromRGB(30,30,30)
	tab.BorderSizePixel = 0
	tab.AutoButtonColor = false

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = tab

	return tab
end

local function createSection()
	local sec = Instance.new("ScrollingFrame")
	sec.Parent = PigeonFrame
	sec.Position = UDim2.new(0, 10, 0, 55)
	sec.Size = UDim2.new(1, -20, 1, -65)

	sec.CanvasSize = UDim2.new(0, 0, 0, 0)
	sec.AutomaticCanvasSize = Enum.AutomaticSize.Y
	sec.ScrollBarThickness = 6
	sec.ScrollBarImageColor3 = Color3.fromRGB(90, 90, 90)
	sec.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
	sec.BorderSizePixel = 0
	sec.Visible = false

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 12)
	corner.Parent = sec

	local pad = Instance.new("UIPadding")
	pad.PaddingTop = UDim.new(0, 10)
	pad.PaddingLeft = UDim.new(0, 10)
	pad.PaddingRight = UDim.new(0, 10)
	pad.PaddingBottom = UDim.new(0, 10)
	pad.Parent = sec

	local layout = Instance.new("UIListLayout")
	layout.Padding = UDim.new(0, 8)
	layout.Parent = sec

	return sec
end

local GeneralStuff = createTab("GENERAL", UDim2.new(0, padding, 0, padding))
local GoodStuff    = createTab("GOOD STUFF", UDim2.new(1/3, padding, 0, padding))
local MiscStuff    = createTab("MISC", UDim2.new(2/3, padding, 0, padding))


local GeneralSection = createSection()
GeneralSection.Visible = true
local GoodSection    = createSection()
local MiscSection    = createSection()

-- Generic Button Creator
local function addButton(section, name, color)
	local button = Instance.new("TextButton")
	button.Parent = section
	button.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
	button.BackgroundColor3 = color or Color3.fromRGB(0,140,255)
	button.TextColor3 = Color3.new(1,1,1)
	button.Font = Enum.Font.GothamBold
	button.TextSize = 14
	button.Text = name

	local index = 0
	for _, c in pairs(section:GetChildren()) do
		if c:IsA("TextButton") then
			index = index + 1
		end
	end

	local col = (index-1) % 2
	local row = math.floor((index-1) / 2)
	button.Position = UDim2.new(0, padding + col*(buttonWidth + padding), 0, padding + row*(buttonHeight + padding))

	return button
end

addButton(GoodSection, "Example Option")
addButton(MiscSection, "Unload GUI", Color3.fromRGB(200,60,60)).MouseButton1Click:Connect(function()
	PigeonGui:Destroy()
end)

-- TAB SWITCHING
local function selectTab(tab)
	GeneralStuff.TextColor3 = Color3.fromRGB(255,255,255)
	GoodStuff.TextColor3    = Color3.fromRGB(255,255,255)
	MiscStuff.TextColor3    = Color3.fromRGB(255,255,255)

	GeneralSection.Visible = false
	GoodSection.Visible = false
	MiscSection.Visible = false

	if tab == GeneralStuff then
		GeneralSection.Visible = true
	elseif tab == GoodStuff then
		GoodSection.Visible = true
	elseif tab == MiscStuff then
		MiscSection.Visible = true
	end

	tab.TextColor3 = Color3.fromRGB(0,255,255)
end

GeneralStuff.MouseButton1Click:Connect(function() selectTab(GeneralStuff) end)
GoodStuff.MouseButton1Click:Connect(function() selectTab(GoodStuff) end)
MiscStuff.MouseButton1Click:Connect(function() selectTab(MiscStuff) end)

-- GUI Toggle with END key
local guiOn = true
UIS.InputBegan:Connect(function(input,gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.End then
		guiOn = not guiOn
		PigeonGui.Enabled = guiOn
	end
end)

-- GENERAL CONTROLS
local sectionY = {
	General = 10,
	Good = 10,
	Misc = 10
}

-- WALK SPEED
local WalkSpeedLabel = Instance.new("TextLabel")
WalkSpeedLabel.Parent = GeneralSection
WalkSpeedLabel.Size = UDim2.new(0,120,0,buttonHeight)
WalkSpeedLabel.BackgroundTransparency = 1
WalkSpeedLabel.Text = "Walk Speed:"
WalkSpeedLabel.TextColor3 = Color3.fromRGB(255,255,255)
WalkSpeedLabel.Font = Enum.Font.GothamBold
WalkSpeedLabel.TextSize = 14
WalkSpeedLabel.TextXAlignment = Enum.TextXAlignment.Left

local WalkSpeedInput = Instance.new("TextBox")
WalkSpeedInput.Parent = GeneralSection
WalkSpeedInput.Size = UDim2.new(0,80,0,buttonHeight)
WalkSpeedInput.PlaceholderText = "16"
WalkSpeedInput.Text = ""
WalkSpeedInput.TextColor3 = Color3.fromRGB(255,255,255)
WalkSpeedInput.Font = Enum.Font.Gotham
WalkSpeedInput.TextSize = 14
WalkSpeedInput.BackgroundColor3 = Color3.fromRGB(60,60,60)
WalkSpeedInput.ClearTextOnFocus = false

local ApplySpeedBtn = Instance.new("TextButton")
ApplySpeedBtn.Parent = GeneralSection
ApplySpeedBtn.Size = UDim2.new(0,80,0,buttonHeight)
ApplySpeedBtn.Text = "Apply"
ApplySpeedBtn.BackgroundColor3 = Color3.fromRGB(0,140,255)
ApplySpeedBtn.TextColor3 = Color3.fromRGB(255,255,255)
ApplySpeedBtn.Font = Enum.Font.GothamBold
ApplySpeedBtn.TextSize = 14

local DisableSpeedBtn = Instance.new("TextButton")
DisableSpeedBtn.Parent = GeneralSection
DisableSpeedBtn.Size = UDim2.new(0,80,0,buttonHeight)
DisableSpeedBtn.Text = "Disable"
DisableSpeedBtn.BackgroundColor3 = Color3.fromRGB(255,0,0)
DisableSpeedBtn.TextColor3 = Color3.fromRGB(255,255,255)
DisableSpeedBtn.Font = Enum.Font.GothamBold
DisableSpeedBtn.TextSize = 14

ApplySpeedBtn.MouseButton1Click:Connect(function()
	local speed = tonumber(WalkSpeedInput.Text)
	if speed then
		local char = plr.Character
		if char and char:FindFirstChild("Humanoid") then
			char.Humanoid.WalkSpeed = speed
		end
	end
end)

DisableSpeedBtn.MouseButton1Click:Connect(function()
	local char = plr.Character
	if char and char:FindFirstChild("Humanoid") then
		char.Humanoid.WalkSpeed = 16
	end
	WalkSpeedInput.Text = ""
end)

currentY = currentY + buttonHeight + padding

-- FLIGHT
local FlightLabel = Instance.new("TextLabel")
FlightLabel.Parent = GeneralSection
FlightLabel.Size = UDim2.new(0,120,0,buttonHeight)
FlightLabel.BackgroundTransparency = 1
FlightLabel.Text = "Flight Speed:"
FlightLabel.TextColor3 = Color3.fromRGB(255,255,255)
FlightLabel.Font = Enum.Font.GothamBold
FlightLabel.TextSize = 14
FlightLabel.TextXAlignment = Enum.TextXAlignment.Left

local FlightInput = Instance.new("TextBox")
FlightInput.Parent = GeneralSection
FlightInput.Size = UDim2.new(0,80,0,buttonHeight)
FlightInput.PlaceholderText = "50"
FlightInput.Text = ""
FlightInput.TextColor3 = Color3.fromRGB(255,255,255)
FlightInput.Font = Enum.Font.Gotham
FlightInput.TextSize = 14
FlightInput.BackgroundColor3 = Color3.fromRGB(60,60,60)
FlightInput.ClearTextOnFocus = false

local ApplyFlightBtn = Instance.new("TextButton")
ApplyFlightBtn.Parent = GeneralSection
ApplyFlightBtn.Size = UDim2.new(0,80,0,buttonHeight)
ApplyFlightBtn.Text = "Apply"
ApplyFlightBtn.BackgroundColor3 = Color3.fromRGB(0,140,255)
ApplyFlightBtn.TextColor3 = Color3.fromRGB(255,255,255)
ApplyFlightBtn.Font = Enum.Font.GothamBold
ApplyFlightBtn.TextSize = 14

local DisableFlightBtn = Instance.new("TextButton")
DisableFlightBtn.Parent = GeneralSection
DisableFlightBtn.Size = UDim2.new(0,80,0,buttonHeight)
DisableFlightBtn.Text = "Disable"
DisableFlightBtn.BackgroundColor3 = Color3.fromRGB(255,0,0)
DisableFlightBtn.TextColor3 = Color3.fromRGB(255,255,255)
DisableFlightBtn.Font = Enum.Font.GothamBold
DisableFlightBtn.TextSize = 14

local flying = false
local flightSpeed = 50
local bodyVelocity
local cam = workspace.CurrentCamera

ApplyFlightBtn.MouseButton1Click:Connect(function()
	local speed = tonumber(FlightInput.Text)
	if speed then
		flightSpeed = speed
		local char = plr.Character
		if char and char:FindFirstChild("HumanoidRootPart") then
			if not flying then
				flying = true
				bodyVelocity = Instance.new("BodyVelocity")
				bodyVelocity.MaxForce = Vector3.new(400000,400000,400000)
				bodyVelocity.Velocity = Vector3.new(0,0,0)
				bodyVelocity.Parent = char.HumanoidRootPart
			end
		end
	end
end)

DisableFlightBtn.MouseButton1Click:Connect(function()
	if flying and bodyVelocity then
		bodyVelocity:Destroy()
	end
	flying = false
	FlightInput.Text = ""
end)

RunService.RenderStepped:Connect(function()
	if flying and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = plr.Character.HumanoidRootPart
		local direction = Vector3.new()
		if UIS:IsKeyDown(Enum.KeyCode.W) then direction = direction + cam.CFrame.LookVector end
		if UIS:IsKeyDown(Enum.KeyCode.S) then direction = direction - cam.CFrame.LookVector end
		if UIS:IsKeyDown(Enum.KeyCode.A) then direction = direction - cam.CFrame.RightVector end
		if UIS:IsKeyDown(Enum.KeyCode.D) then direction = direction + cam.CFrame.RightVector end
		if UIS:IsKeyDown(Enum.KeyCode.Space) then direction = direction + Vector3.new(0,1,0) end
		if direction.Magnitude > 0 then
			bodyVelocity.Velocity = direction.Unit * flightSpeed
		else
			bodyVelocity.Velocity = Vector3.new(0,0,0)
		end
	end
end)

currentY = currentY + buttonHeight + padding

-- TELEPORT TO MOUSE
local TpLabel = Instance.new("TextLabel")
TpLabel.Parent = GeneralSection
TpLabel.Size = UDim2.new(0,160,0,buttonHeight)
TpLabel.BackgroundTransparency = 1
TpLabel.Text = "Teleport to Mouse:"
TpLabel.TextColor3 = Color3.fromRGB(255,255,255)
TpLabel.Font = Enum.Font.GothamBold
TpLabel.TextSize = 14
TpLabel.TextXAlignment = Enum.TextXAlignment.Left

local TpCheckbox = Instance.new("TextButton")
TpCheckbox.Parent = GeneralSection
TpCheckbox.Size = UDim2.new(0,30,0,buttonHeight)
TpCheckbox.BackgroundColor3 = Color3.fromRGB(60,60,60)
TpCheckbox.Text = ""
TpCheckbox.AutoButtonColor = false

local TpEnabled = false
TpCheckbox.MouseButton1Click:Connect(function()
	TpEnabled = not TpEnabled
	if TpEnabled then
		TpCheckbox.BackgroundColor3 = Color3.fromRGB(0,140,255)
	else
		TpCheckbox.BackgroundColor3 = Color3.fromRGB(60,60,60)
	end
end)

RunService.RenderStepped:Connect(function()
	if TpEnabled and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
		if UIS:IsKeyDown(Enum.KeyCode.LeftControl) and UIS:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then
			local hrp = plr.Character.HumanoidRootPart
			local mousePos = UIS:GetMouseLocation()
			local ray = workspace.CurrentCamera:ScreenPointToRay(mousePos.X, mousePos.Y)
			local targetPos = ray.Origin + ray.Direction * 100
			hrp.CFrame = CFrame.new(targetPos + Vector3.new(0,3,0))
		end
	end
end)

currentY = currentY + buttonHeight + padding

-- INFINITE JUMP
local InfiniteJumpLabel = Instance.new("TextLabel")
InfiniteJumpLabel.Parent = GeneralSection
InfiniteJumpLabel.Size = UDim2.new(0,120,0,buttonHeight)
InfiniteJumpLabel.BackgroundTransparency = 1
InfiniteJumpLabel.Text = "Infinite Jump:"
InfiniteJumpLabel.TextColor3 = Color3.fromRGB(255,255,255)
InfiniteJumpLabel.Font = Enum.Font.GothamBold
InfiniteJumpLabel.TextSize = 14
InfiniteJumpLabel.TextXAlignment = Enum.TextXAlignment.Left

local InfiniteJumpBox = Instance.new("TextButton")
InfiniteJumpBox.Parent = GeneralSection
InfiniteJumpBox.Size = UDim2.new(0,30,0,buttonHeight)
InfiniteJumpBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
InfiniteJumpBox.Text = ""
InfiniteJumpBox.AutoButtonColor = false

local infiniteJumpEnabled = false
InfiniteJumpBox.MouseButton1Click:Connect(function()
	infiniteJumpEnabled = not infiniteJumpEnabled
	if infiniteJumpEnabled then
		InfiniteJumpBox.BackgroundColor3 = Color3.fromRGB(0,140,255)
	else
		InfiniteJumpBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
	end
end)

UIS.JumpRequest:Connect(function()
	if infiniteJumpEnabled then
		local char = plr.Character
		if char and char:FindFirstChild("Humanoid") then
			char.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
		end
	end
end)

currentY = currentY + buttonHeight + padding

-- NOCLIP
local NoclipLabel = Instance.new("TextLabel")
NoclipLabel.Parent = GeneralSection
NoclipLabel.Size = UDim2.new(0,120,0,buttonHeight)
NoclipLabel.BackgroundTransparency = 1
NoclipLabel.Text = "Noclip:"
NoclipLabel.TextColor3 = Color3.fromRGB(255,255,255)
NoclipLabel.Font = Enum.Font.GothamBold
NoclipLabel.TextSize = 14
NoclipLabel.TextXAlignment = Enum.TextXAlignment.Left

local NoclipBox = Instance.new("TextButton")
NoclipBox.Parent = GeneralSection
NoclipBox.Size = UDim2.new(0,30,0,buttonHeight)
NoclipBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
NoclipBox.Text = ""
NoclipBox.AutoButtonColor = false

local noclipEnabled = false
NoclipBox.MouseButton1Click:Connect(function()
	noclipEnabled = not noclipEnabled
	if noclipEnabled then
		NoclipBox.BackgroundColor3 = Color3.fromRGB(0,140,255)
	else
		NoclipBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
	end
end)

RunService.Stepped:Connect(function()
	if noclipEnabled and plr.Character then
		for _, part in pairs(plr.Character:GetChildren()) do
			if part:IsA("BasePart") and part.CanCollide then
				part.CanCollide = false
			end
		end
	end
end)

currentY = currentY + buttonHeight + padding

-- REMOVE INSANITY
local RemoveLabel = Instance.new("TextLabel")
RemoveLabel.Parent = GeneralSection
RemoveLabel.Size = UDim2.new(0,120,0,buttonHeight)
RemoveLabel.BackgroundTransparency = 1
RemoveLabel.Text = "Remove Insanity:"
RemoveLabel.TextColor3 = Color3.fromRGB(255,255,255)
RemoveLabel.Font = Enum.Font.GothamBold
RemoveLabel.TextSize = 14
RemoveLabel.TextXAlignment = Enum.TextXAlignment.Left

local RemoveBtn = Instance.new("TextButton")
RemoveBtn.Parent = GeneralSection
RemoveBtn.Size = UDim2.new(0,80,0,buttonHeight)
RemoveBtn.Text = "Remove"
RemoveBtn.TextColor3 = Color3.fromRGB(255,255,255)
RemoveBtn.Font = Enum.Font.GothamBold
RemoveBtn.TextSize = 14
RemoveBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
RemoveBtn.BorderColor3 = Color3.fromRGB(128,0,128)

RemoveBtn.MouseButton1Click:Connect(function()
	local insanityScript = plr.PlayerGui:FindFirstChild("Temp")
	if insanityScript and insanityScript:FindFirstChild("Insanity") then
		insanityScript.Insanity:Destroy()
	end
end)

currentY = currentY + buttonHeight + padding

-- REMOVE FOG
local RemoveFogLabel = Instance.new("TextLabel")
RemoveFogLabel.Parent = GeneralSection
RemoveFogLabel.Size = UDim2.new(0,140,0,buttonHeight)
RemoveFogLabel.BackgroundTransparency = 1
RemoveFogLabel.Text = "Remove Fog:"
RemoveFogLabel.TextColor3 = Color3.fromRGB(255,255,255)
RemoveFogLabel.Font = Enum.Font.GothamBold
RemoveFogLabel.TextSize = 14
RemoveFogLabel.TextXAlignment = Enum.TextXAlignment.Left

local RemoveFogBtn = Instance.new("TextButton")
RemoveFogBtn.Parent = GeneralSection
RemoveFogBtn.Size = UDim2.new(0,80,0,buttonHeight)
RemoveFogBtn.Text = "Remove"
RemoveFogBtn.TextColor3 = Color3.fromRGB(255,255,255)
RemoveFogBtn.Font = Enum.Font.GothamBold
RemoveFogBtn.TextSize = 14
RemoveFogBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
RemoveFogBtn.BorderColor3 = Color3.fromRGB(128,0,128)

RemoveFogBtn.MouseButton1Click:Connect(function()
	local tempFolder = plr.PlayerGui:FindFirstChild("Temp")
	if tempFolder and tempFolder:FindFirstChild("FogParticles") then
		tempFolder.FogParticles:Destroy()
	end
end)

currentY = currentY + buttonHeight + padding

-- AUTO WASH
local WashLabel = Instance.new("TextLabel")
WashLabel.Parent = GeneralSection
WashLabel.Size = UDim2.new(0,120,0,buttonHeight)
WashLabel.BackgroundTransparency = 1
WashLabel.Text = "Auto Wash:"
WashLabel.TextColor3 = Color3.fromRGB(255,255,255)
WashLabel.Font = Enum.Font.GothamBold
WashLabel.TextSize = 14
WashLabel.TextXAlignment = Enum.TextXAlignment.Left

local WashToggle = Instance.new("TextButton")
WashToggle.Parent = GeneralSection
WashToggle.Size = UDim2.new(0,30,0,buttonHeight)
WashToggle.BackgroundColor3 = Color3.fromRGB(60,60,60)
WashToggle.Text = ""
WashToggle.AutoButtonColor = false

local washEnabled = false
local washThread = nil

WashToggle.MouseButton1Click:Connect(function()
	washEnabled = not washEnabled

	if washEnabled then
		WashToggle.BackgroundColor3 = Color3.fromRGB(0,140,255)

		washThread = task.spawn(function()
			while washEnabled do
				local washRemote =
					game.ReplicatedStorage
					:WaitForChild("RS")
					:WaitForChild("Remotes")
					:WaitForChild("Boats")
					:WaitForChild("Wash")

				washRemote:FireServer()
				task.wait(2)
			end
		end)
	else
		WashToggle.BackgroundColor3 = Color3.fromRGB(60,60,60)
	end
end)

currentY = currentY + buttonHeight + padding


-- BirdKill Label
local BirdKillLabel = Instance.new("TextLabel")
BirdKillLabel.Parent = GeneralSection
BirdKillLabel.Size = UDim2.new(0,140,0,buttonHeight)
BirdKillLabel.BackgroundTransparency = 1
BirdKillLabel.Text = "Auto BirdKill:"
BirdKillLabel.TextColor3 = Color3.fromRGB(255,255,255)
BirdKillLabel.Font = Enum.Font.GothamBold
BirdKillLabel.TextSize = 14
BirdKillLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Toggle Button
local BirdKillToggle = Instance.new("TextButton")
BirdKillToggle.Parent = GeneralSection
BirdKillToggle.Size = UDim2.new(0,30,0,buttonHeight)
BirdKillToggle.BackgroundColor3 = Color3.fromRGB(60,60,60)
BirdKillToggle.Text = ""
BirdKillToggle.AutoButtonColor = false

-- Logic
local birdKillEnabled = false
local birdKillThread

local BirdKillRemote = game.ReplicatedStorage
	:WaitForChild("RS")
	:WaitForChild("Remotes")
	:WaitForChild("Misc")
	:WaitForChild("BirdKill")

BirdKillToggle.MouseButton1Click:Connect(function()
	birdKillEnabled = not birdKillEnabled

	if birdKillEnabled then
		BirdKillToggle.BackgroundColor3 = Color3.fromRGB(0,150,255)

		birdKillThread = task.spawn(function()
			while birdKillEnabled do
				BirdKillRemote:FireServer("Eagle")
				task.wait(1)
			end
		end)
	else
		BirdKillToggle.BackgroundColor3 = Color3.fromRGB(60,60,60)
	end
end)

currentY = currentY + buttonHeight + padding

-- ==========================
-- CHEST ESP (OPTIMIZED + DESTROY @ 20 STUDS)
-- ==========================

local ChestToggle = addButton(MiscSection, "Chest ESP")
ChestToggle.BackgroundColor3 = Color3.fromRGB(60,60,60)

local player = game.Players.LocalPlayer

local CHEST_NAMES = {
	["Treasure Chest"] = Color3.fromRGB(255,255,255),
	["Uncommon Chest"] = Color3.fromRGB(255,255,255),
	["Rare Chest"] = Color3.fromRGB(255,255,255),
	["Mystic Chest"] = Color3.fromRGB(255,0,0),
	["Legendary Chest"] = Color3.fromRGB(0,255,0),
}

local MAX_DISTANCE = 2000
local CLOSE_DISTANCE = 20

local espEnabled = false
local espObjects = {}
local removedChests = {}

-- Create ESP ONCE
local function createESP(model)
	if espObjects[model] or removedChests[model] then return end

	local primary = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
	if not primary then return end

	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ChestESP"
	billboard.Adornee = primary
	billboard.Size = UDim2.new(0, 90, 0, 18)
	billboard.StudsOffset = Vector3.new(0, 2.5, 0)
	billboard.AlwaysOnTop = true

	local text = Instance.new("TextLabel")
	text.Parent = billboard
	text.Size = UDim2.new(1,0,1,0)
	text.BackgroundTransparency = 1
	text.Text = model.Name
	text.Font = Enum.Font.GothamBold
	text.TextSize = 13
	text.TextScaled = false
	text.TextStrokeTransparency = 0.3
	text.TextColor3 = CHEST_NAMES[model.Name] or Color3.new(1,1,1)

	billboard.Parent = model
	espObjects[model] = billboard
end

-- Main update loop (1s scan)
task.spawn(function()
	while true do
		if espEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			local hrpPos = player.Character.HumanoidRootPart.Position

			for _, model in ipairs(workspace:GetDescendants()) do
				if model:IsA("Model") and CHEST_NAMES[model.Name] and not removedChests[model] then
					local primary = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
					if primary then
						local dist = (primary.Position - hrpPos).Magnitude

						if dist <= CLOSE_DISTANCE then
							if espObjects[model] then
								espObjects[model]:Destroy()
								espObjects[model] = nil
							end
							removedChests[model] = true

						elseif dist <= MAX_DISTANCE then
							createESP(model)

						elseif espObjects[model] then
							espObjects[model]:Destroy()
							espObjects[model] = nil
						end
					end
				end
			end
		end
		task.wait(1)
	end
end)

-- Toggle button
ChestToggle.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	ChestToggle.BackgroundColor3 = espEnabled and Color3.fromRGB(0,140,255) or Color3.fromRGB(60,60,60)

	if not espEnabled then
		for _, gui in pairs(espObjects) do
			if gui then gui:Destroy() end
		end
		espObjects = {}
	end
end)

local function updateCanvas(section)
	section.CanvasSize = UDim2.new(0, 0, 0, currentY + 20)
end

-- Call after building UI
updateCanvas(GeneralSection)
updateCanvas(GoodSection)
updateCanvas(MiscSection)
